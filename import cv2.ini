import cv2
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
import time
import os
import threading
import subprocess
import signal
import sys
import logging
import json
import hashlib
import traceback

# è¨­å®šæˆªåœ–å„²å­˜è·¯å¾‘
SCREENSHOT_RTMP = "stream_captures"
os.makedirs(SCREENSHOT_RTMP, exist_ok=True)

# è¨­å®š log ç´€éŒ„æª”
logging.basicConfig(
    filename="error_log.txt",
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)

stop_event = threading.Event()

last_image_hash = {}

def file_hash(path):
    hasher = hashlib.md5()
    with open(path, 'rb') as afile:
        buf = afile.read()
        hasher.update(buf)
    return hasher.hexdigest()
#æŠ“åœ–æ¯”å°ç‡ï¼Œè¨˜å¾—æ”¹åœ–ç‰‡æª”æ¡ˆï¼Œå¯ä»¥åœ¨VLCç•°å¸¸æŠ“åœ–
def capture_rtmp_ffmpeg(name, rtmp_url, interval=10, template_path="_123.png", threshold=0.40):
    retry_count = 0
    max_retries = 3
    repeat_count = 0
    max_repeat = 3
    while retry_count <= max_retries and not stop_event.is_set():
        timestamp = time.strftime("%Y%m%d_%H%M%S")
        filename = os.path.join(SCREENSHOT_RTMP, f"{name}_{timestamp}.jpg")

        cmd = [
            r"C:\ffmpeg\bin\ffmpeg.exe",
            "-y",
            "-i", rtmp_url,
            "-frames:v", "1",
            "-q:v", "2",
            filename
        ]

        try:
            subprocess.run(cmd, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL, timeout=5)

            if os.path.exists(filename):
                current_hash = file_hash(filename)
                if name in last_image_hash and last_image_hash[name] == current_hash:
                    repeat_count += 1
                    print(f"âš ï¸ [{name}] é‡è¤‡åœ–ç‰‡ {repeat_count}/{max_repeat}")
                    if repeat_count >= max_repeat:
                        print(f"ğŸ”„ [{name}] æª¢æ¸¬åˆ°é‡è¤‡åœ–ç‰‡è¶…éæ¬¡æ•¸ï¼Œé‡é€£è§¸ç™¼")
                        logging.warning(f"{name} é‡è¤‡åœ–ç‰‡è§¸ç™¼é‡é€£ï¼š{filename}")
                        retry_count += 1
                        time.sleep(2)
                        continue
                else:
                    repeat_count = 0
                    last_image_hash[name] = current_hash

                img_rgb = cv2.imread(filename)
                if img_rgb is not None and img_rgb.shape[0] > 0 and img_rgb.shape[1] > 0:
                    #è¨˜å¾—æ”¹åœ–ç‰‡è·¯å¾‘
                    template = cv2.imread(r"C:\Users\User\Desktop\AutoCase\_123.png")
                    if template is not None:
                        result = cv2.matchTemplate(img_rgb, template, cv2.TM_CCOEFF_NORMED)
                        min_val, max_val, min_loc, max_loc = cv2.minMaxLoc(result)
                        print(f"ğŸ” [{name}] Template match åˆ†æ•¸ï¼š{max_val:.5f}")
                        if max_val >= threshold:
                            print(f"âŒ [{name}] åµæ¸¬åˆ°éŒ¯èª¤ç•«é¢ï¼Œå·²æˆªåœ–ï¼š{filename}")
                            logging.warning(f"{name} detect error screen: {filename}")
                        else:
                            print(f"âœ… [{name}] åœ–ç‰‡æ­£å¸¸ï¼ˆæœªä¿å­˜ï¼‰")
                            os.remove(filename)
                    else:
                        print(f"âŒ ç„¡æ³•è¼‰å…¥éŒ¯èª¤æ¨¡æ¿åœ–ç‰‡ï¼š{template_path}")
                        logging.error(f"{name} template not found: {template_path}")
                else:
                    print(f"âš ï¸ [{name}] æ“·å–åœ–ç‰‡ç„¡æ•ˆï¼Œå°‡åˆªé™¤ {filename}")
                    logging.warning(f"{name} invalid image: {filename}")
                    os.remove(filename)
            else:
                print(f"âŒ [{name}] æ“·å–å¾Œæ‰¾ä¸åˆ°åœ–ç‰‡ï¼š{filename}")
                logging.error(f"{name} missing image: {filename}")
            break
        except subprocess.TimeoutExpired:
            print(f"âš ï¸ [{name}] FFmpeg æ“·å–è¶…æ™‚ï¼Œæº–å‚™é‡è©¦ ({retry_count + 1}/{max_retries})")
            logging.warning(f"{name} FFmpeg timeout retry {retry_count + 1}/{max_retries}")
            retry_count += 1
            time.sleep(2)

#æ‰¾éŠæˆ²ç”¨çš„
def scroll_and_click_game(driver, game_title_code):
    try:
        # ç­‰å¾…æ‰€æœ‰å¯é»æ“Šçš„éŠæˆ²å…ƒç´ åŠ è¼‰å®Œæˆ
        items = WebDriverWait(driver, 10).until(
            EC.presence_of_all_elements_located((By.ID, "grid_gm_item"))
        )

        # éæ­·ä¸¦é»æ“Šç¬¦åˆæ¢ä»¶çš„éŠæˆ²å¡ç‰‡
        for item in items:
            title = item.get_attribute("title")
            if title and game_title_code in title:
                driver.execute_script("arguments[0].scrollIntoView();", item)
                time.sleep(1)
                driver.execute_script("arguments[0].click();", item)
                print(f"âœ… æˆåŠŸé»æ“ŠéŠæˆ²: {title}")
                time.sleep(2)

                try:
                    # ç²å–é é¢ä¸Šæ‰€æœ‰çš„ Join æŒ‰éˆ•ï¼Œå› ç‚ºæ–° DOM å¯èƒ½ä¸å±¬æ–¼ item
                    join_btns = WebDriverWait(driver, 5).until(
                        EC.presence_of_all_elements_located((By.XPATH, "//div[contains(@class, 'gm-info-box')]//span[text()='Join']"))
                    )
                    for join_btn in join_btns:
                        if join_btn.is_displayed():
                            driver.execute_script("arguments[0].click();", join_btn)
                            print("ğŸ® æˆåŠŸé»æ“Š Join é€²å…¥éŠæˆ²")
                            time.sleep(7)
                            click_multiple_positions(driver, ['18,38'])
                            print("é»æ“Š18,38")

                            return True
                    print("âš ï¸ æ‰¾åˆ° gm-info-boxï¼Œä½†æ²’æœ‰å¯è¦‹çš„ Join æŒ‰éˆ•")
                except Exception as join_err:
                    print(f"âš ï¸ æ‰¾åˆ°éŠæˆ²å¡ç‰‡ä½†æ‰¾ä¸åˆ° Join æŒ‰éˆ•: {join_err}")

        print(f"âŒ ç„¡æ³•åœ¨å¤§å»³ä¸­æ‰¾åˆ°éŠæˆ²: {game_title_code}")
        return False
            
    except Exception as e:
        print(f"âŒ åŸ·è¡Œæ»‘å‹•ä¸¦é»æ“ŠéŠæˆ²æ™‚å¤±æ•—: {e}")
    return False

def click_multiple_positions(driver, positions):
    for pos in positions:
        try:
            xpath = f"//span[text()='{pos}']"
            elems = WebDriverWait(driver, 2).until(
                EC.presence_of_all_elements_located((By.XPATH, xpath))
            )
            if elems:
                driver.execute_script("arguments[0].click();", elems[0])
                print(f"âœ… å·²é»æ“Šåº§æ¨™ä½: {pos}")
                time.sleep(1) # å»¶é²ä¸€ç§’
        except Exception as e:
            print(f"âŒ æ‰¾ä¸åˆ°åº§æ¨™ä½ {pos}: {e}")

def spin_forever(driver, rtmp_name=None, rtmp_url=None, game_title_code=None):
    last_check_time = 0
    try:
        while not stop_event.is_set():
            current_time = time.time()
            if current_time - last_check_time >= 10:
                if rtmp_name and rtmp_url:
                    capture_rtmp_ffmpeg(rtmp_name, rtmp_url, template_path="error_template.png")
                last_check_time = current_time

            spin_clicked = False
            try:
                try:
                    balance_elem = driver.find_element(By.CSS_SELECTOR, ".balance-bg.hand_balance .text2")
                    bal_text = balance_elem.text.replace(",", "").strip()
                    if bal_text.isdigit() and int(bal_text) < 20000:
                        print(f"âš ï¸ BAL éä½ï¼ˆ{bal_text}ï¼‰ï¼ŒåŸ·è¡Œé€€å‡ºæµç¨‹...")
                        logging.warning(f"{rtmp_name} BAL too low: {bal_text}")

                        # é»æ“Š Cashout æŒ‰éˆ•
                        try:
                            quit_btn = driver.find_element(By.CSS_SELECTOR, ".my-button.btn_cashout")
                            driver.execute_script("arguments[0].click();", quit_btn)
                            time.sleep(2)

                            # é»æ“Š Exit To Lobby æŒ‰éˆ•
                            exit_btn = driver.find_element(By.CSS_SELECTOR, ".function-btn .reserve-btn-gray")
                            driver.execute_script("arguments[0].click();", exit_btn)
                            print("ğŸšª å·²é»æ“Š Exit To Lobby")
                            time.sleep(5)

                            # é»æ“Š Confirm æŒ‰éˆ•ï¼ˆbox-btnï¼‰ï¼Œå› ç‚ºæœ‰å…©å€‹æŒ‰éˆ•ï¼Œåªèƒ½é€™æ¨£å¯«
                            confirm_btn = driver.find_element(By.XPATH, "//button[.//div[text()='Confirm']]")
                            driver.execute_script("arguments[0].click();", confirm_btn)
                            print("âœ… å·²ç¢ºèªé€€å‡º")
                            time.sleep(5)

                            # å¦‚æœæ²’é»æ“ŠæˆåŠŸï¼Œå˜—è©¦è¿”å›å¤§å»³é»æ“ŠéŠæˆ²
                            print(f"é€€å‡ºå¾Œè¿”å›åŸæ©Ÿå™¨: {game_title_code}")
                            scroll_and_click_game(driver, game_title_code)
                            time.sleep(3)
                            continue

                        except Exception as quit_err:
                            print(f"âŒ æ‰¾ä¸åˆ°é€€å‡ºæŒ‰éˆ•æˆ–æ“ä½œå¤±æ•—: {quit_err}")

                except Exception as bal_err:
                    print(f"âš ï¸ ç„¡æ³•å–å¾— BAL æ•¸å€¼: {bal_err}")

                spin_btn = WebDriverWait(driver, 10).until(
                    EC.presence_of_element_located((By.CSS_SELECTOR, ".my-button.btn_spin"))
                )
                driver.execute_script("arguments[0].click();", spin_btn)
                print("âœ… å·²é»æ“Š Spin:")
                print(f"å‰©é¤˜ï¼ˆ{bal_text}ï¼‰")

                spin_clicked = True
            #éŠæˆ²çš„åº§æ¨™ï¼Œæ¯ä¸€æ¬¾ä¸åŒï¼Œä¸»è¦æ‡‰å°å°éŠæˆ²
                click_multiple_positions(driver, ['4,2','4,4','4,6','7,1','7,4','7,6','10,2','10,4','10,6','13,2','13,4','13,6'])  # åŠ å…¥åº§æ¨™é»æ“Š

            except Exception as click_err:
                print(f"âŒ {game_title_code} æ‰¾ä¸åˆ° Spin æˆ–é»æ“Šå¤±æ•—: {click_err}")
                if not spin_clicked and game_title_code:
                    # å¦‚æœæ²’é»æ“ŠæˆåŠŸï¼Œå˜—è©¦è¿”å›å¤§å»³é»æ“ŠéŠæˆ²
                    print(f"â¡ï¸ å˜—è©¦è¿”å›å¤§å»³ä¸¦é‡æ–°é»æ“Š: {game_title_code}")
                    scroll_and_click_game(driver, game_title_code)
            time.sleep(1)

    except KeyboardInterrupt:
        print("ğŸ›‘ æ‰‹å‹•ä¸­æ­¢è¿´åœˆï¼Œç¨‹å¼å·²çµæŸ")
        driver.quit()

def launch_driver(url):
    edge_options = webdriver.EdgeOptions()
    edge_options.add_argument("--user-agent=Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.127 Mobile Safari/537.36")
    edge_options.add_argument("--window-size=432,859")
    edge_options.add_argument("--incognito")
    driver = webdriver.Edge(options=edge_options)
    driver.get(url)
    return driver

def run_game_test(config):
    url = config.get("url")
    rtmp_name = config.get("rtmp")
    rtmp_url = config.get("rtmp_url")
    game_title_code = config.get("game_title_code")

    print(f"â¡ï¸  åˆå§‹åŒ–éŠæˆ²æ¸¬è©¦: {config}")

    driver = launch_driver(url)
    try:
        spin_forever(driver, rtmp_name=rtmp_name, rtmp_url=rtmp_url, game_title_code=game_title_code)
    except Exception as e:
        print(f"âŒ ç™¼ç”Ÿä¾‹å¤–: {e}")
        traceback.print_exc()
        if rtmp_name and rtmp_url:
            capture_rtmp_ffmpeg(rtmp_name + "_Exception", rtmp_url, template_path="error_template.png")
        time.sleep(1)

def handle_interrupt(sig, frame):
    print("\nğŸ›‘ æ”¶åˆ° Ctrl+C ä¸­æ–·æŒ‡ä»¤ï¼Œæ­£åœ¨ä¸­æ­¢æ‰€æœ‰åŸ·è¡Œç·’...")
    stop_event.set()
    sys.exit(0)

signal.signal(signal.SIGINT, handle_interrupt)

if __name__ == "__main__":
    try:
        with open("game_config.json", "r", encoding="utf-8") as f:
            game_config = json.load(f)

        threads = []
        for conf in game_config:
            print(f"âœ… è¼‰å…¥è¨­å®š: {conf}")
            t = threading.Thread(target=run_game_test, args=(conf,))
            t.start()
            threads.append(t)

        for t in threads:
            t.join()

    except KeyboardInterrupt:
        print("ğŸ›‘ åµæ¸¬åˆ°ä¸­æ–·è¨Šè™Ÿï¼Œæ­£åœ¨é—œé–‰æ‰€æœ‰åŸ·è¡Œç·’...")
        stop_event.set()